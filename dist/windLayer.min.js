/*!
 * author: FDD <smileFDD@gmail.com> 
 * wind-layer v0.0.6
 * build-time: 2019-3-20 16:43
 * LICENSE: MIT
 * (c) 2017-2019 https://sakitam-fdd.github.io/wind-layer
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.windLayer=e()}(this,function(){"use strict";function n(t,e){t.prototype=Object.create(e.prototype),(t.prototype.constructor=t).__proto__=e}function a(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var o=function(p){p.projection||(p.projection="EPSG:4326");var f,g,h,v,m,w,y,u,d,M,c=p.minVelocity||0,l=p.maxVelocity||10,o=(p.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1),_=p.particleAge||90,x=p.lineWidth||1,b=p.particleMultiplier||1/300,I=Math.pow(window.devicePixelRatio,1/3)||1.6,E=1e3/(p.frameRate||15),C=p.colorScale||["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"],r=[NaN,NaN,null],s=p.data,z=function(t,e,n,i,a,o){var r=1-t,s=1-e,h=r*s,u=t*s,d=r*e,c=t*e,l=n[0]*h+i[0]*u+a[0]*d+o[0]*c,p=n[1]*h+i[1]*u+a[1]*d+o[1]*c;return[l,p,Math.sqrt(l*l+p*p)]},F=function(t){var e,n,i,a,o=null,r=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"1,2":case"2,2":o=t;break;case"1,3":case"2,3":r=t}}),n=r,i=(e=o).data,a=n.data,{header:e.header,data:function(t){return[i[t],a[t]]},interpolate:z}},N=function(t,e){if(!g)return null;var n,i=W(t-v,360)/w,a=(m-e)/y,o=Math.floor(i),r=o+1,s=Math.floor(a),h=s+1;if(n=g[s]){var u=n[o],d=n[r];if(P(u)&&P(d)&&(n=g[h])){var c=n[o],l=n[r];if(P(c)&&P(l))return f.interpolate(i-o,a-s,u,d,c,l)}}return null},P=function(t){return null!=t},W=function(t,e){return t-e*Math.floor(t/e)},S=function(t,e,n,i,a,o,r,s){var h=r[0]*o,u=r[1]*o,d=D(t,e,n,i,a,s);return r[0]=d[0]*h+d[2]*u,r[1]=d[1]*h+d[3]*u,r},D=function(t,e,n,i,a,o){var r=2*Math.PI,s="EPSG:4326"===p.projection?5:Math.pow(10,-5.2),h=e<0?s:-s,u=n<0?s:-s,d=B(n,e+h,o),c=B(n+u,e,o),l=Math.cos(n/360*r);return[(d[0]-i)/h/l,(d[1]-a)/h/l,(c[0]-i)/u,(c[1]-a)/u]},L=function(i,a,t){function o(t,e){var n=i[Math.round(t)];return n&&n[Math.round(e)]||r}o.release=function(){i=[]},o.randomize=function(t){for(var e,n,i=0;null===o(e=Math.round(Math.floor(Math.random()*a.width)+a.x),n=Math.round(Math.floor(Math.random()*a.height)+a.y))[2]&&i++<30;);return t.x=e,t.y=n,t},t(a,o)},R=function(t){return t/180*Math.PI},T=function(t){return t/(Math.PI/180)};M="EPSG:4326"===p.projection?function(t,e,n){var i=n.east-n.west,a=n.south-n.north,o=T(n.north)+e/n.height*T(a);return[T(n.west)+t/n.width*T(i),o]}:function(t,e,n){var i=n.east-n.west,a=n.width/T(i)*360/(2*Math.PI),o=a/2*Math.log((1+Math.sin(n.south))/(1-Math.sin(n.south))),r=(n.height+o-e)/a,s=180/Math.PI*(2*Math.atan(Math.exp(r))-Math.PI/2);return[T(n.west)+t/n.width*T(i),s]};var j,A=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},B=function(t,e,n){var i=A(n.south),a=A(n.north),o=n.width/(n.east-n.west),r=n.height/(a-i),s=A(R(t));return[(R(e)-n.west)*o,s=(a-s)*r]},$=function(i,s){var e,n,h=(e=c,n=l,C.indexFor=function(t){return Math.max(0,Math.min(C.length-1,Math.round((t-e)/(n-e)*(C.length-1))))},C),u=h.map(function(){return[]}),t=Math.round(i.width*i.height*b);/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)&&(t*=I);for(var a=[],o=0;o<t;o++)a.push(s.randomize({age:Math.floor(Math.random()*_)+0}));var r=p.canvas.getContext("2d");r.lineWidth=x,r.fillStyle="rgba(0, 0, 0, 0.97)",r.globalAlpha=.6;var d=Date.now();!function t(){j=requestAnimationFrame(t);var e=Date.now(),n=e-d;E<n&&(d=e-n%E,u.forEach(function(t){t.length=0}),a.forEach(function(t){t.age>_&&(s.randomize(t).age=0);var e=t.x,n=t.y,i=s(e,n),a=i[2];if(null===a)t.age=_;else{var o=e+i[0],r=n+i[1];null!==s(o,r)[2]?(t.xt=o,t.yt=r,u[h.indexFor(a)].push(t)):(t.x=o,t.y=r)}t.age+=1}),r.globalCompositeOperation="destination-in",r.fillRect(i.x,i.y,i.width,i.height),r.globalCompositeOperation="lighter",r.globalAlpha=.9,u.forEach(function(t,e){0<t.length&&(r.beginPath(),r.strokeStyle=h[e],t.forEach(function(t){r.moveTo(t.x,t.y),r.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),r.stroke())}))}()},O=function(e,n,i,t){var a={south:R(t[0][1]),north:R(t[1][1]),east:R(t[1][0]),west:R(t[0][0]),width:n,height:i};q(),function(t,e){var n=(f=F(t)).header;v=n.lo1,m=Math.max(n.la2,n.la1),w=n.dx,y=n.dy,u=n.nx,d=n.ny,(h=new Date(n.refTime)).setHours(h.getHours()+n.forecastTime),g=[];for(var i=0,a=360<=Math.floor(u*w),o=0;o<d;o++){for(var r=[],s=0;s<u;s++,i++)r[s]=f.data(i);a&&r.push(r[0]),g[o]=r}e({date:h,interpolate:N})}(s,function(t){!function(s,h,u,n){var d={},t=(u.south-u.north)*(u.west-u.east),c=o*Math.pow(t,.4),l=[],i=h.x;function a(t){for(var e=[],n=h.y;n<=h.yMax;n+=2){var i=M(t,n,u);if(i){var a=i[0],o=i[1];if(isFinite(a)){var r=s.interpolate(a,o);r&&(r=S(d,a,o,t,n,c,r,u),e[n+1]=e[n]=r)}}}l[t+1]=l[t]=e}!function t(){for(var e=Date.now();i<h.width;)if(a(i),i+=2,1e3<Date.now()-e)return void setTimeout(t,25);L(l,h,n)}()}(t,function(t,e,n){var i=t[0],a=t[1],o=Math.round(i[0]),r=Math.max(Math.floor(i[1],0),0);Math.min(Math.ceil(a[0],e),e-1);return{x:o,y:r,xMax:e,yMax:Math.min(Math.ceil(a[1],n),n-1),width:e,height:n}}(e,n,i),a,function(t,e){V.field=e,$(t,e)})})},q=function(){V.field&&V.field.release(),j&&cancelAnimationFrame(j)},V={params:p,start:O,stop:q,update:function(t,e,n,i,a){delete p.data,p.data=t,a&&O(e,n,i,a)},shift:function(t,e){var n=p.canvas,i=n.width,a=n.height,o=n.getContext("2d");if(t<i&&e<a){var r=function(t,e){return Math.max(0,Math.min(t,e))},s=o.getImageData(r(i,-t),r(a,-e),r(i,i-t),r(a,a-e));o.clearRect(0,0,i,a),o.putImageData(s,r(i,t),r(a,e));for(var h=0,u=particles.length;h<u;h++)particles[h].x+=t,particles[h].y+=e}},createField:L,interpolatePoint:N,setData:function(t){s=t}};return V};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/FRAME_RATE)},window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});var r=function(t,e,n){if("undefined"!=typeof document){var i=document.createElement("canvas");return i.width=t,i.height=e,i}return new n(t,e)},s=function(t,e,n){n.endsWith("CCW")&&(e=0<e?e=-e:Math.abs(e));var i=Math.sqrt(Math.pow(t,2)+Math.pow(e,2)),a=180*Math.atan2(t/i,e/i)/Math.PI+180;return"bearingCW"!==n&&"meteoCCW"!==n||360<=(a+=180)&&(a-=360),a},h=function(t,e,n){var i=Math.sqrt(Math.pow(t,2)+Math.pow(e,2));return"k/h"===n?d(i):"kt"===n?u(i):i},u=function(t){return t/.514},d=function(t){return 3.6*t},c=("undefined"==typeof window?{}:window).ol||{};c.layer||(c.layer={}),c.layer.Image||(c.layer.Image=function(){});var t=function(i){function t(t,e){var n;return void 0===e&&(e={}),(n=i.call(this,e)||this)._canvas=null,n.data=t,n.$Windy=null,n.isClear=!1,n.options=e,n.setSource(new c.source.ImageCanvas({logo:e.logo,state:e.state,attributions:e.attributions,resolutions:e.resolutions,canvasFunction:n.canvasFunction.bind(a(a(n))),ratio:e.hasOwnProperty("ratio")?e.ratio:1})),n.on("precompose",n.redraw,a(a(n))),n}n(t,i);var e=t.prototype;return e.getData=function(){return this.data},e.setData=function(t){var e=this.getMap();if(!e)return this;if(this.data=t,this.isClear=!1,!this.$Windy&&this._canvas)this.render(this._canvas),e.renderSync();else if(this.$Windy&&this._canvas){this._cloneLayer&&(e.addLayer(this._cloneLayer),delete this._cloneLayer);var n=this._getExtent();this.$Windy.update(this.getData(),n[0],n[1],n[2],n[3])}else console.warn("please create new instance");return this},e.render=function(t){var e=this._getExtent();if(this.isClear||!this.getData()||!e)return this;if(t&&!this.$Windy)this.$Windy=new o({canvas:t,projection:this._getProjectionCode(),data:this.getData()}),this.$Windy.start(e[0],e[1],e[2],e[3]);else if(t&&this.$Windy){var n=this._getExtent();this.$Windy.start(n[0],n[1],n[2],n[3])}return this},e.redraw=function(){if(!this.isClear){var t=this.options.extent||this._getMapExtent();this.setExtent(t)}},e.canvasFunction=function(t,e,n,i,a){return this._canvas?(this._canvas.width=i[0],this._canvas.height=i[1]):this._canvas=r(i[0],i[1]),e<=this.get("maxResolution")&&this.render(this._canvas),this._canvas},e._getExtent=function(){var t=this._getMapSize(),e=this._getMapExtent();if(t&&e){var n=this._getProjectionCode(),i=c.proj.transformExtent(e,n,"EPSG:4326");return[[[0,0],[t[0],t[1]]],t[0],t[1],[[i[0],i[1]],[i[2],i[3]]]]}return!1},e._getMapExtent=function(){if(this.getMap()){var t=this._getMapSize(),e=this.getMap().getView();return e&&e.calculateExtent(t)}},e._getMapSize=function(){if(this.getMap())return this.getMap().getSize()},e.appendTo=function(t){if(!(t&&t instanceof c.Map))throw new Error("not map object");this.set("originMap",t),this.getSource().projection_=this._getProjectionCode(),t.addLayer(this)},e.getPointData=function(t){var e=this.$Windy.interpolatePoint(t[0],t[1]);if(e&&!isNaN(e[0])&&!isNaN(e[1])&&e[2])return{direction:s(e[0],e[1],this.options.angleConvention||"bearingCCW"),speed:h(e[0],e[1],this.options.speedUnit)}},e.clearWind=function(){var t=this.getMap();t&&(this.$Windy&&this.$Windy.stop(),this.isClear=!0,this._cloneLayer=this,t.removeLayer(this),this.changed(),this.getMap().renderSync())},e.removeLayer=function(){var t=this.getMap();t&&(this.$Windy&&this.$Windy.stop(),this.un("precompose",this.redraw,this),t.removeLayer(this),delete this._canvas,delete this.$Windy,delete this._cloneLayer)},e.setMap=function(t){this.set("originMap",t)},e.getMap=function(){return this.get("originMap")},e._getProjectionCode=function(){var t=this.getMap();return t?t.getView()&&t.getView().getProjection().getCode():"EPSG:3857"},t}(c.layer.Image),l=("undefined"==typeof window?{}:window).AMap||{},e=function(){function t(t,e){void 0===e&&(e={}),this.options=e,this.canvas=null,this.data=t,this.layer_=null,this._windy=null,e.map&&this.appendTo(e.map),this.init=this.init.bind(this),this.handleResize=this.handleResize.bind(this),this.canvasFunction=this.canvasFunction.bind(this),this._addReFreshHandle=this._addReFreshHandle.bind(this)}var e=t.prototype;return e.appendTo=function(t){if(!t)throw new Error("not map object");this.init(t)},e.getData=function(){return this.data},e.setData=function(t){this.data=t,this.map&&this.canvas&&this.data&&this.render()},e.init=function(t,e){if(!t)throw new Error("not map object");this.map=t,this.context=this.options.context||"2d",this.getCanvasLayer(),this.map.on("resize",this.handleResize,this)},e.handleResize=function(){this.canvas&&this.canvasFunction()},e.render=function(t){if(t){var e=this._getExtent();return this.getData()&&e&&(t&&!this._windy?(this._windy=new o({canvas:t,data:this.getData(),onDraw:function(){}}),this._windy.start(e[0],e[1],e[2],e[3])):t&&this._windy&&this._windy.start(e[0],e[1],e[2],e[3]),this._addReFreshHandle()),this}},e._addReFreshHandle=function(){"3d"===this.map.getViewMode_().toLowerCase()&&(this.layer_&&this.layer_.reFresh(),l.Util.requestAnimFrame(this._addReFreshHandle))},e.getCanvasLayer=function(){if(!this.canvas&&!this.layer_){var t=this.canvasFunction(),e=this._getBounds();this.layer_=new l.CanvasLayer({canvas:t,bounds:this.options.bounds||e,zooms:this.options.zooms||[0,22],zIndex:this.options.zIndex||12,opacity:this.options.opacity||1}),this.map.on("mapmove",this.canvasFunction,this),this.map.on("zoomchange",this.canvasFunction,this),this.layer_.setMap(this.map)}},e.canvasFunction=function(){var t=[this.map.getSize().width,this.map.getSize().height],e=t[0],n=t[1];if(this.canvas){this.canvas.width=e,this.canvas.height=n;var i=this._getBounds();this.layer_&&this.layer_.setBounds(this.options.bounds||i)}else this.canvas=r(e,n,null);return this.render(this.canvas),this.canvas},e._getBounds=function(){var t,e,n=this.map.getViewMode_(),i=[],a=i[0],o=i[1],r=this.map.getBounds();if("2d"===n.toLowerCase())o=r.getNorthEast(),a=r.getSouthWest();else{var s=r.bounds.map(function(t){return[t.getLng(),t.getLat()]}),h=(t=s,e=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],t.reduce(function(t,e){return[Math.min(e[0],t[0]),Math.min(e[1],t[1]),Math.max(e[0],t[2]),Math.max(e[1],t[3])]},e));a=new l.LngLat(h[0],h[1]),o=new l.LngLat(h[2],h[3])}return new l.Bounds(a,o)},e._getExtent=function(){var t=[this.map.getSize().width,this.map.getSize().height],e=t[0],n=t[1],i=this._getBounds().getNorthEast(),a=this._getBounds().getSouthWest();return[[[0,0],[e,n]],e,n,[[i.lng,i.lat],[a.lng,a.lat]]]},e.removeLayer=function(){this.map&&(this.map.removeLayer(this.layer_),this.map.off("resize",this.handleResize,this),this.map.off("mapmove",this.canvasFunction,this),this.map.off("zoomchange",this.canvasFunction,this),delete this.map,delete this.layer_,delete this.canvas)},e.getContext=function(){return this.canvas.getContext(this.context)},e.getPointData=function(t){var e=this._windy.interpolatePoint(t[0],t[1]);if(e&&!isNaN(e[0])&&!isNaN(e[1])&&e[2])return{direction:s(e[0],e[1],this.options.angleConvention||"bearingCCW"),speed:h(e[0],e[1],this.options.speedUnit)}},e.clearWind=function(){this._windy&&this._windy.stop()},t}(),p="undefined"==typeof window?{}:window;return p.BMap||(p.BMap={}),p.BMap.Overlay||(p.BMap.Overlay=function(){}),{AMapWind:e,BMapWind:function(i){function t(t,e){var n;return void 0===e&&(e={}),(n=i.call(this,e)||this).options=e,n.paneName=n.options.paneName||"mapPane",n.context=n.options.context||"2d",n.zIndex=n.options.zIndex||0,n.mixBlendMode=n.options.mixBlendMode||null,n.enableMassClear=n.options.enableMassClear,n._map=e.map,n._lastDrawTime=null,n.canvas=null,n.data=t,n._windy=null,n.show(),n}n(t,i);var e=t.prototype;return e.getData=function(){return this.data},e.setData=function(t){this.data=t,this._map&&this.data&&this._draw()},e._getExtent=function(){var t=this._map.getSize(),e=this._map.getBounds().getNorthEast(),n=this._map.getBounds().getSouthWest();return[[[0,0],[t.width,t.height]],t.width,t.height,[[e.lng,e.lat],[n.lng,n.lat]]]},e.appendTo=function(t){if(!t)throw new Error("not map object");t.addOverlay(this)},e.initialize=function(t){var e=this;this._map=t;var n=this.canvas=document.createElement("canvas");return n.style.cssText="position:absolute; left:0; top:0; z-index: "+this.zIndex+" ;user-select:none;",n.style.mixBlendMode=this.mixBlendMode,this.adjustSize(),t.getPanes()[this.paneName].appendChild(n),t.addEventListener("resize",function(){e.adjustSize(),e._draw()}),this.canvas},e.adjustSize=function(){var t=this._map.getSize(),e=this.canvas,n=this.devicePixelRatio=p.devicePixelRatio||1;e.width=t.width*n,e.height=t.height*n,"2d"===this.context&&e.getContext(this.context).scale(n,n),e.style.width=t.width+"px",e.style.height=t.height+"px"},e.draw=function(){var t=this;clearTimeout(t.timeoutID),t.timeoutID=setTimeout(function(){t._draw()},15)},e._draw=function(){var t=this._map,e=t.getSize(),n=t.getCenter();if(n){var i=t.pointToOverlayPixel(n);this.canvas.style.left=i.x-e.width/2+"px",this.canvas.style.top=i.y-e.height/2+"px",this.dispatchEvent("draw"),this.options.update&&this.options.update.call(this),this.render(this.canvas)}},e.render=function(t){var e=this._getExtent();return this.getData()&&e&&(t&&!this._windy?(this._windy=new o({canvas:t,data:this.getData(),onDraw:function(){}}),this._windy.start(e[0],e[1],e[2],e[3])):t&&this._windy&&this._windy.start(e[0],e[1],e[2],e[3])),this},e.getContainer=function(){return this.canvas},e.setZIndex=function(t){this.zIndex=t,this.canvas.style.zIndex=this.zIndex},e.getZIndex=function(){return this.zIndex},e.getPointData=function(t){var e=this._windy.interpolatePoint(t[0],t[1]);if(e&&!isNaN(e[0])&&!isNaN(e[1])&&e[2])return{direction:s(e[0],e[1],this.options.angleConvention||"bearingCCW"),speed:h(e[0],e[1],this.options.speedUnit)}},e.clearWind=function(){this._windy&&this._windy.stop()},t}(p.BMap.Overlay),OlWind:t}});