/*!
 * author: FDD <smileFDD@gmail.com> 
 * wind-layer v0.0.5
 * build-time: 2018-2-6 15:9
 * LICENSE: MIT
 * (c) 2017-2018 https://sakitam-fdd.github.io/wind-layer
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("openlayers")):"function"==typeof define&&define.amd?define(["openlayers"],e):t.WindLayer=e(t.ol)}(this,function(i){"use strict";i=i&&i.hasOwnProperty("default")?i.default:i;var o=function(d){var p,g,h,y,v,w,M,u,c,m,i=.005*(Math.pow(window.devicePixelRatio,1/3)||1),x=90,b=Math.pow(window.devicePixelRatio,1/3)||1.6,_=1e3/15,o=[NaN,NaN,null],f=function(t,e,n,a,r,i){var o=1-t,s=1-e,h=o*s,u=t*s,c=o*e,f=t*e;return[n[0]*h+a[0]*u+r[0]*c+i[0]*f,n[1]*h+a[1]*u+r[1]*c+i[1]*f,n[2]*h+a[2]*u+r[2]*c+i[2]*f]},l=function(t){var e,n,a,r,i,o=null,s=null,h=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"2,2":o=t;break;case"2,3":s=t;break;case"0,0":h=t}}),n=s,a=h,r=(e=o).data,i=n.data,{header:e.header,data:function(t){return[r[t],i[t],a.data[t]]},interpolate:f}},E=function(t,e){if(!g)return null;var n,a=F(t-y,360)/w,r=(v-e)/M,i=Math.floor(a),o=i+1,s=Math.floor(r),h=s+1;if(n=g[s]){var u=n[i],c=n[o];if(P(u)&&P(c)&&(n=g[h])){var f=n[i],l=n[o];if(P(f)&&P(l))return p.interpolate(a-i,r-s,u,c,f,l)}}return null},P=function(t){return null!=t},F=function(t,e){return t-e*Math.floor(t/e)},W=function(t,e,n,a,r,i,o,s){var h=o[0]*i,u=o[1]*i,c=j(t,e,n,a,r,s);return o[0]=c[0]*h+c[2]*u,o[1]=c[1]*h+c[3]*u,o},j=function(t,e,n,a,r,i){var o=2*Math.PI,s="EPSG:4326"===d.projection?5:Math.pow(10,-5.2),h=e<0?s:-s,u=n<0?s:-s,c=L(n,e+h,i),f=L(n+u,e,i),l=Math.cos(n/360*o);return[(c[0]-a)/h/l,(c[1]-r)/h/l,(f[0]-a)/u,(f[1]-r)/u]},A=function(a,r,t){function i(t,e){if(!a)return[NaN,NaN,null];var n=a[Math.round(t)];return n&&n[Math.round(e)]||o}i.release=function(){a=[]},i.randomize=function(t){for(var e,n,a=0;null===i(e=Math.round(Math.floor(Math.random()*r.width)+r.x),n=Math.round(Math.floor(Math.random()*r.height)+r.y))[2]&&a++<30;);return t.x=e,t.y=n,t},t(r,i)},S=function(t){return t/180*Math.PI},$=function(t){return t/(Math.PI/180)};m="EPSG:4326"===d.projection?function(t,e,n){var a=n.east-n.west,r=n.south-n.north,i=$(n.north)+e/n.height*$(r);return[$(n.west)+t/n.width*$(a),i]}:function(t,e,n){var a=n.east-n.west,r=n.width/$(a)*360/(2*Math.PI),i=r/2*Math.log((1+Math.sin(n.south))/(1-Math.sin(n.south))),o=(n.height+i-e)/r,s=180/Math.PI*(2*Math.atan(Math.exp(o))-Math.PI/2);return[$(n.west)+t/n.width*$(a),s]};var R,C,I=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},L=function(t,e,n){var a=I(n.south),r=I(n.north),i=n.width/(n.east-n.west),o=n.height/(r-a),s=I(S(t));return[(S(e)-n.west)*i,s=(r-s)*o]},s=function(a,s,t){var e,n,r,h=(e=261.15,n=317.15,(r=["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"]).indexFor=function(t){return Math.max(0,Math.min(r.length-1,Math.round((t-e)/(n-e)*(r.length-1))))},r),u=h.map(function(){return[]}),i=(t.south-t.north)*(t.west-t.east),o=Math.round(a.width*a.height*.005*Math.pow(i,.24));/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)&&(o/=b),(R=R||[]).length>o&&(R=R.slice(0,o));for(var c=R.length;c<o;c++)R.push(s.randomize({age:0+~~(Math.random()*x)}));var f=d.canvas.getContext("2d");f.lineWidth=1;var l=Date.now();!function t(){C=requestAnimationFrame(t);var e=Date.now(),n=e-l;_<n&&(l=e-n%_,u.forEach(function(t){t.length=0}),R.forEach(function(t){t.age>x&&(s.randomize(t).age=~~(Math.random()*x/2));var e=t.x,n=t.y,a=s(e,n),r=a[2];if(null===r)t.age=x;else{var i=e+a[0],o=n+a[1];null!==s(i,o)[0]?(t.xt=i,t.yt=o,u[h.indexFor(r)].push(t)):(t.x=i,t.y=o)}t.age+=1}),f.save(),f.globalAlpha=.16,f.globalCompositeOperation="destination-out",f.fillStyle="#000",f.fillRect(a.x,a.y,a.width,a.height),f.restore(),u.forEach(function(t,e){0<t.length&&(f.beginPath(),f.strokeStyle=h[e],t.forEach(function(t){f.moveTo(t.x,t.y),f.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),f.stroke())}))}()},D=function(e,n,a,t){var r={south:S(t[0][1]),north:S(t[1][1]),east:S(t[1][0]),west:S(t[0][0]),width:n,height:a};T(),function(t,e){var n=(p=l(t)).header;y=n.lo1,v=n.la1,w=n.dx,M=n.dy,u=n.nx,c=n.ny,(h=new Date(n.refTime)).setHours(h.getHours()+n.forecastTime),g=[];for(var a=0,r=360<=Math.floor(u*w),i=0;i<c;i++){for(var o=[],s=0;s<u;s++,a++)o[s]=p.data(a);r&&o.push(o[0]),g[i]=o}e({date:h,interpolate:E})}(d.data,function(t){!function(s,h,u,t){var c={},e=(u.south-u.north)*(u.west-u.east),f=i*Math.pow(e,.3),l=[],n=h.x;function a(t){for(var e=[],n=h.y;n<=h.yMax;n+=2){var a=m(t,n,u);if(a){var r=a[0],i=a[1];if(isFinite(r)){var o=s.interpolate(r,i);o&&(o=W(c,r,i,t,n,f,o,u),e[n+1]=e[n]=o)}}}l[t+1]=l[t]=e}for(;n<h.width;n+=2)a(n);A(l,h,t)}(t,function(t,e,n){var a=t[0],r=t[1],i=Math.round(a[0]),o=Math.max(Math.floor(a[1],0),0);Math.min(Math.ceil(r[0],e),e-1);return{x:i,y:o,xMax:e,yMax:Math.min(Math.ceil(r[1],n),n-1),width:e,height:n}}(e,n,a),r,function(t,e){N.field=e,s(t,e,r)})})},T=function(){N.field&&N.field.release(),C&&cancelAnimationFrame(C)},N={params:d,start:D,stop:T,update:function(t,e,n,a,r){delete d.data,d.data=t,r&&D(e,n,a,r)},shift:function(t,e){var n=d.canvas,a=n.width,r=n.height,i=n.getContext("2d");if(t<a&&e<r){var o=function(t,e){return Math.max(0,Math.min(t,e))},s=i.getImageData(o(a,-t),o(r,-e),o(a,a-t),o(r,r-e));i.clearRect(0,0,a,r),i.putImageData(s,o(a,t),o(r,e));for(var h=0,u=R.length;h<u;h++)R[h].x+=t,R[h].y+=e}},createField:A,interpolatePoint:E};return N};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/FRAME_RATE)},window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});var s=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},h=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e};return function(a){function r(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};s(this,r);var n=h(this,a.call(this,e));return n._canvas=null,n.data=t,n.$Windy=null,n.isClear=!1,n.options=e,n.setSource(new i.source.ImageCanvas({logo:e.logo,state:e.state,attributions:e.attributions,resolutions:e.resolutions,canvasFunction:n.canvasFunction.bind(n),projection:e.hasOwnProperty("projection")?e.projection:"EPSG:3857",ratio:e.hasOwnProperty("ratio")?e.ratio:1})),n.on("precompose",n.redraw,n),n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(r,a),r.prototype.getData=function(){return this.data},r.prototype.setData=function(t){var e=this.getMap();if(!e)return this;if(this.data=t,this.isClear=!1,!this.$Windy&&this._canvas)this.render(this._canvas),e.renderSync();else if(this.$Windy&&this._canvas){this._cloneLayer&&(e.addLayer(this._cloneLayer),delete this._cloneLayer);var n=this._getExtent();this.$Windy.update(this.getData(),n[0],n[1],n[2],n[3])}else console.warn("please create new instance");return this},r.prototype.render=function(t){var e=this._getExtent();if(this.isClear||!this.getData()||!e)return this;if(t&&!this.$Windy)this.$Windy=new o({canvas:t,projection:this.get("projection"),data:this.getData()}),this.$Windy.start(e[0],e[1],e[2],e[3]);else if(t&&this.$Windy){var n=this._getExtent();this.$Windy.start(n[0],n[1],n[2],n[3])}return this},r.prototype.redraw=function(){if(!this.isClear){var t=this.options.extent||this._getMapExtent();this.setExtent(t)}},r.prototype.canvasFunction=function(t,e,n,a,r){return this._canvas?(this._canvas.width=a[0],this._canvas.height=a[1]):this._canvas=function(t,e,n){if("undefined"!=typeof document){var a=document.createElement("canvas");return a.width=t,a.height=e,a}return new n(t,e)}(a[0],a[1]),e<=this.get("maxResolution")&&this.render(this._canvas),this._canvas},r.prototype._getExtent=function(){var t=this._getMapSize(),e=this._getMapExtent();if(t&&e){var n=this.get("projection"),a=i.proj.transformExtent(e,n,"EPSG:4326");return[[[0,0],[t[0],t[1]]],t[0],t[1],[[a[0],a[1]],[a[2],a[3]]]]}return!1},r.prototype._getMapExtent=function(){if(this.getMap()){var t=this._getMapSize(),e=this.getMap().getView();return e&&e.calculateExtent(t)}},r.prototype._getMapSize=function(){if(this.getMap())return this.getMap().getSize()},r.prototype.appendTo=function(t){if(!(t&&t instanceof i.Map))throw new Error("not map object");this.set("originMap",t),t.addLayer(this)},r.prototype.clearWind=function(){var t=this.getMap();t&&(this.$Windy&&this.$Windy.stop(),this.isClear=!0,this._cloneLayer=this,t.removeLayer(this),this.changed(),this.getMap().renderSync())},r.prototype.removeLayer=function(){var t=this.getMap();t&&(this.$Windy&&this.$Windy.stop(),this.un("precompose",this.redraw,this),t.removeLayer(this),delete this._canvas,delete this.$Windy,delete this._cloneLayer)},r.prototype.setMap=function(t){this.set("originMap",t)},r.prototype.getMap=function(){return this.get("originMap")},r}(i.layer.Image)});