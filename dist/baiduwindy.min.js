/*!
 * author: FDD <smileFDD@gmail.com>
 * wind-layer v0.0.5
 * build-time: 2018-2-6 15:6
 * LICENSE: MIT
 * (c) 2017-2018 https://sakitam-fdd.github.io/wind-layer
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.BaiduWindy=e()}(this,function(){"use strict";var n=function(f){var p,w,s,m,g,v,y,u,d,x,M,o=.005*(Math.pow(window.devicePixelRatio,1/3)||1),b=90,_=Math.pow(window.devicePixelRatio,1/3)||1.6,z=1e3/15,r=[NaN,NaN,null],l=function(t,e,n,a,i,o){var r=1-t,h=1-e,s=r*h,u=t*h,d=r*e,l=t*e;return[n[0]*s+a[0]*u+i[0]*d+o[0]*l,n[1]*s+a[1]*u+i[1]*d+o[1]*l,n[2]*s+a[2]*u+i[2]*d+o[2]*l]},c=function(t){var e,n,a,i,o,r=null,h=null,s=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"2,2":r=t;break;case"2,3":h=t;break;case"0,0":s=t}}),n=h,a=s,i=(e=r).data,o=n.data,{header:e.header,data:function(t){return[i[t],o[t],a.data[t]]},interpolate:l}},E=function(t,e){if(!w)return null;var n,a=F(t-m,360)/v,i=(g-e)/y,o=Math.floor(a),r=o+1,h=Math.floor(i),s=h+1;if(n=w[h]){var u=n[o],d=n[r];if(I(u)&&I(d)&&(n=w[s])){var l=n[o],c=n[r];if(I(l)&&I(c))return p.interpolate(a-o,i-h,u,d,l,c)}}return null},I=function(t){return null!=t},F=function(t,e){return t-e*Math.floor(t/e)},P=function(t,e,n,a,i,o,r,h){var s=r[0]*o,u=r[1]*o,d=T(t,e,n,a,i,h);return r[0]=d[0]*s+d[2]*u,r[1]=d[1]*s+d[3]*u,r},T=function(t,e,n,a,i,o){var r=2*Math.PI,h=e<0?5:-5,s=n<0?5:-5,u=C(n,e+h,o),d=C(n+s,e,o),l=Math.cos(n/360*r);return[(u[0]-a)/h/l,(u[1]-i)/h/l,(d[0]-a)/s,(d[1]-i)/s]},A=function(a,i,t){function o(t,e){if(!a)return[NaN,NaN,null];var n=a[Math.round(t)];return n&&n[Math.round(e)]||r}o.release=function(){a=[]},o.randomize=function(t){for(var e,n,a=0;null===o(e=Math.round(Math.floor(Math.random()*i.width)+i.x),n=Math.round(Math.floor(Math.random()*i.height)+i.y))[2]&&a++<30;);return t.x=e,t.y=n,t},t(i,o)},N=function(t){return t/180*Math.PI},h=function(t){return t/(Math.PI/180)},R=function(t,e,n){var a=n.east-n.west,i=n.south-n.north,o=h(n.north)+e/n.height*h(i);return[h(n.west)+t/n.width*h(a),o]},D=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},C=function(t,e,n){var a=D(n.south),i=D(n.north),o=n.width/(n.east-n.west),r=n.height/(i-a),h=D(N(t));return[(N(e)-n.west)*o,h=(i-h)*r]},S=function(a,h,t){var e,n,i,s=(e=261.15,n=317.15,(i=["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"]).indexFor=function(t){return Math.max(0,Math.min(i.length-1,Math.round((t-e)/(n-e)*(i.length-1))))},i),u=s.map(function(){return[]}),o=(t.south-t.north)*(t.west-t.east),r=Math.round(a.width*a.height*.005*Math.pow(o,.24));/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)&&(r/=_),(x=x||[]).length>r&&(x=x.slice(0,r));for(var d=x.length;d<r;d++)x.push(h.randomize({age:0+~~(Math.random()*b)}));var l=f.canvas.getContext("2d");l.lineWidth=1;var c=Date.now();!function t(){M=requestAnimationFrame(t);var e=Date.now(),n=e-c;z<n&&(c=e-n%z,u.forEach(function(t){t.length=0}),x.forEach(function(t){t.age>b&&(h.randomize(t).age=~~(Math.random()*b/2));var e=t.x,n=t.y,a=h(e,n),i=a[2];if(null===i)t.age=b;else{var o=e+a[0],r=n+a[1];null!==h(o,r)[0]?(t.xt=o,t.yt=r,u[s.indexFor(i)].push(t)):(t.x=o,t.y=r)}t.age+=1}),l.save(),l.globalAlpha=.16,l.globalCompositeOperation="destination-out",l.fillStyle="#000",l.fillRect(a.x,a.y,a.width,a.height),l.restore(),u.forEach(function(t,e){0<t.length&&(l.beginPath(),l.strokeStyle=s[e],t.forEach(function(t){l.moveTo(t.x,t.y),l.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),l.stroke())}))}()},j=function(e,n,a,t){var i={south:N(t[0][1]),north:N(t[1][1]),east:N(t[1][0]),west:N(t[0][0]),width:n,height:a};O(),function(t,e){var n=(p=c(t)).header;m=n.lo1,g=n.la1,v=n.dx,y=n.dy,u=n.nx,d=n.ny,(s=new Date(n.refTime)).setHours(s.getHours()+n.forecastTime),w=[];for(var a=0,i=360<=Math.floor(u*v),o=0;o<d;o++){for(var r=[],h=0;h<u;h++,a++)r[h]=p.data(a);i&&r.push(r[0]),w[o]=r}e({date:s,interpolate:E})}(f.data,function(t){!function(h,s,u,t){var d={},e=(u.south-u.north)*(u.west-u.east),l=o*Math.pow(e,.3),c=[],n=s.x;function a(t){for(var e=[],n=s.y;n<=s.yMax;n+=2){var a=R(t,n,u);if(a){var i=a[0],o=a[1];if(isFinite(i)){var r=h.interpolate(i,o);r&&(r=P(d,i,o,t,n,l,r,u),e[n+1]=e[n]=r)}}}c[t+1]=c[t]=e}for(;n<s.width;n+=2)a(n);A(c,s,t)}(t,function(t,e,n){var a=t[0],i=t[1],o=Math.round(a[0]),r=Math.max(Math.floor(a[1],0),0);Math.min(Math.ceil(i[0],e),e-1);return{x:o,y:r,xMax:e,yMax:Math.min(Math.ceil(i[1],n),n-1),width:e,height:n}}(e,n,a),i,function(t,e){B.field=e,S(t,e,i)})})},O=function(){B.field&&B.field.release(),M&&cancelAnimationFrame(M)},B={params:f,start:j,stop:O,update:function(t,e,n,a,i){delete f.data,f.data=t,i&&j(e,n,a,i)},shift:function(t,e){var n=f.canvas,a=n.width,i=n.height,o=n.getContext("2d");if(t<a&&e<i){var r=function(t,e){return Math.max(0,Math.min(t,e))},h=o.getImageData(r(a,-t),r(i,-e),r(a,a-t),r(i,i-e));o.clearRect(0,0,a,i),o.putImageData(h,r(a,t),r(i,e));for(var s=0,u=x.length;s<u;s++)x[s].x+=t,x[s].y+=e}},createField:A,interpolatePoint:E};return B};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/FRAME_RATE)},window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});var o=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},r=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},h="undefined"==typeof window?{}:window;return function(a){function i(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};o(this,i);var n=r(this,a.call(this,e));return n.options=e,n.paneName=n.options.paneName||"mapPane",n.context=n.options.context||"2d",n.zIndex=n.options.zIndex||0,n.mixBlendMode=n.options.mixBlendMode||null,n.enableMassClear=n.options.enableMassClear,n._map=e.map,n._lastDrawTime=null,n.canvas=null,n.data=t,n._windy=null,n.show(),n}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(i,a),i.prototype.getData=function(){return this.data},i.prototype._getExtent=function(){var t=this._map.getSize(),e=this._map.getBounds().getNorthEast(),n=this._map.getBounds().getSouthWest();return[[[0,0],[t.width,t.height]],t.width,t.height,[[e.lng,e.lat],[n.lng,n.lat]]]},i.prototype.appendTo=function(t){if(!t)throw new Error("not map object");t.addOverlay(this)},i.prototype.initialize=function(t){var e=this;this._map=t;var n=this.canvas=document.createElement("canvas");return n.style.cssText="position:absolute; left:0; top:0; z-index: "+this.zIndex+" ;user-select:none;",n.style.mixBlendMode=this.mixBlendMode,this.adjustSize(),t.getPanes()[this.paneName].appendChild(n),t.addEventListener("resize",function(){e.adjustSize(),e._draw()}),this.canvas},i.prototype.adjustSize=function(){var t=this._map.getSize(),e=this.canvas,n=this.devicePixelRatio=h.devicePixelRatio||1;e.width=t.width*n,e.height=t.height*n,"2d"===this.context&&e.getContext(this.context).scale(n,n),e.style.width=t.width+"px",e.style.height=t.height+"px"},i.prototype.draw=function(){var t=this;clearTimeout(t.timeoutID),t.timeoutID=setTimeout(function(){t._draw()},15)},i.prototype._draw=function(){var t=this._map,e=t.getSize(),n=t.getCenter();if(n){var a=t.pointToOverlayPixel(n);this.canvas.style.left=a.x-e.width/2+"px",this.canvas.style.top=a.y-e.height/2+"px",this.dispatchEvent("draw"),this.options.update&&this.options.update.call(this),this.render(this.canvas)}},i.prototype.render=function(t){var e=this._getExtent();return this.getData()&&e&&(t&&!this._windy?(this._windy=new n({canvas:t,data:this.getData(),onDraw:function(){}}),this._windy.start(e[0],e[1],e[2],e[3])):t&&this.$Windy&&this._windy.start(e[0],e[1],e[2],e[3])),this},i.prototype.getContainer=function(){return this.canvas},i.prototype.setZIndex=function(t){this.zIndex=t,this.canvas.style.zIndex=this.zIndex},i.prototype.getZIndex=function(){return this.zIndex},i}(h.BMap.Overlay)});
