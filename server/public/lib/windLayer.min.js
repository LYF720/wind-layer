/*!
 * author: FDD <smileFDD@gmail.com>
 * wind-layer v0.0.3
 * LICENSE: MIT
 * (c) 2017-2018 https://sakitam-fdd.github.io/wind-layer
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("openlayers")):"function"==typeof define&&define.amd?define(["openlayers"],e):t.WindLayer=e(t.ol)}(this,function(t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var e=function(t){var e,n,i,a,r,o,s,h,u,c,d=.005*(Math.pow(window.devicePixelRatio,1/3)||1),l=90,p=Math.pow(window.devicePixelRatio,1/3)||1.6,f=1e3/15,m=[NaN,NaN,null],g=function(t,e,n,i,a,r){var o=1-t,s=1-e,h=o*s,u=t*s,c=o*e,d=t*e;return[n[0]*h+i[0]*u+a[0]*c+r[0]*d,n[1]*h+i[1]*u+a[1]*c+r[1]*d,n[2]*h+i[2]*u+a[2]*c+r[2]*d]},v=function(t){var e,n,i,a,r,o=null,s=null,h=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"2,2":o=t;break;case"2,3":s=t;break;case"0,0":h=t}}),n=s,i=h,a=(e=o).data,r=n.data,{header:e.header,data:function(t){return[a[t],r[t],i.data[t]]},interpolate:g}},w=function(t,i){if(!n)return null;var h,u=M(t-a,360)/o,c=(r-i)/s,d=Math.floor(u),l=d+1,p=Math.floor(c),f=p+1;if(h=n[p]){var m=h[d],g=h[l];if(y(m)&&y(g)&&(h=n[f])){var v=h[d],w=h[l];if(y(v)&&y(w))return e.interpolate(u-d,c-p,m,g,v,w)}}return null},y=function(t){return null!==t&&void 0!==t},M=function(t,e){return t-e*Math.floor(t/e)},$=function(t,e,n,i,a,r,o,s){var h=o[0]*r,u=o[1]*r,c=x(t,e,n,i,a,s);return o[0]=c[0]*h+c[2]*u,o[1]=c[1]*h+c[3]*u,o},x=function(e,n,i,a,r,o){var s=2*Math.PI,h="EPSG:4326"===t.projection?5:Math.pow(10,-5.2),u=n<0?h:-h,c=i<0?h:-h,d=z(i,n+u,o),l=z(i+c,n,o),p=Math.cos(i/360*s);return[(d[0]-a)/u/p,(d[1]-r)/u/p,(l[0]-a)/c,(l[1]-r)/c]},E=function(t,e,n){function i(e,n){if(!t)return[NaN,NaN,null];var i=t[Math.round(e)];return i&&i[Math.round(n)]||m}i.release=function(){t=[]},i.randomize=function(t){var n,a,r=0;do{n=Math.round(Math.floor(Math.random()*e.width)+e.x),a=Math.round(Math.floor(Math.random()*e.height)+e.y)}while(null===i(n,a)[2]&&r++<30);return t.x=n,t.y=a,t},n(e,i)},b=function(t){return t/180*Math.PI},P=function(t){return t/(Math.PI/180)};c="EPSG:4326"===t.projection?function(t,e,n){var i=n.east-n.west,a=n.south-n.north,r=P(n.north)+e/n.height*P(a);return[P(n.west)+t/n.width*P(i),r]}:function(t,e,n){var i=n.east-n.west,a=n.width/P(i)*360/(2*Math.PI),r=a/2*Math.log((1+Math.sin(n.south))/(1-Math.sin(n.south))),o=(n.height+r-e)/a,s=180/Math.PI*(2*Math.atan(Math.exp(o))-Math.PI/2);return[P(n.west)+t/n.width*P(i),s]};var F,R,_=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},z=function(t,e,n){var i=_(n.south),a=_(n.north),r=n.width/(n.east-n.west),o=n.height/(a-i),s=_(b(t));return[(b(e)-n.west)*r,s=(a-s)*o]},S=function(e,n,i){var a,r,o,s=(a=261.15,r=317.15,(o=["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"]).indexFor=function(t){return Math.max(0,Math.min(o.length-1,Math.round((t-a)/(r-a)*(o.length-1))))},o),h=s.map(function(){return[]}),u=(i.south-i.north)*(i.west-i.east),c=Math.round(e.width*e.height*.005*Math.pow(u,.24));/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)&&(c/=p),(F=F||[]).length>c&&(F=F.slice(0,c));for(var d=F.length;d<c;d++)F.push(n.randomize({age:0+~~(Math.random()*l)}));var m=t.canvas.getContext("2d");m.lineWidth=1;var g=Date.now();!function t(){R=requestAnimationFrame(t);var i=Date.now(),a=i-g;a>f&&(g=i-a%f,h.forEach(function(t){t.length=0}),F.forEach(function(t){t.age>l&&(n.randomize(t).age=~~(Math.random()*l/2));var e=t.x,i=t.y,a=n(e,i),r=a[2];if(null===r)t.age=l;else{var o=e+a[0],u=i+a[1];null!==n(o,u)[0]?(t.xt=o,t.yt=u,h[s.indexFor(r)].push(t)):(t.x=o,t.y=u)}t.age+=1}),m.save(),m.globalAlpha=.16,m.globalCompositeOperation="destination-out",m.fillStyle="#000",m.fillRect(e.x,e.y,e.width,e.height),m.restore(),h.forEach(function(t,e){t.length>0&&(m.beginPath(),m.strokeStyle=s[e],t.forEach(function(t){m.moveTo(t.x,t.y),m.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),m.stroke())}))}()},W=function(l,p,f,m){var g={south:b(m[0][1]),north:b(m[1][1]),east:b(m[1][0]),west:b(m[0][0]),width:p,height:f};A(),function(t,c){var d=(e=v(t)).header;a=d.lo1,r=d.la1,o=d.dx,s=d.dy,h=d.nx,u=d.ny,(i=new Date(d.refTime)).setHours(i.getHours()+d.forecastTime),n=[];for(var l=0,p=Math.floor(h*o)>=360,f=0;f<u;f++){for(var m=[],g=0;g<h;g++,l++)m[g]=e.data(l);p&&m.push(m[0]),n[f]=m}c({date:i,interpolate:w})}(t.data,function(t){!function(t,e,n,i){var a={},r=(n.south-n.north)*(n.west-n.east),o=d*Math.pow(r,.3),s=[],h=e.x;function u(i){for(var r=[],h=e.y;h<=e.yMax;h+=2){var u=c(i,h,n);if(u){var d=u[0],l=u[1];if(isFinite(d)){var p=t.interpolate(d,l);p&&(p=$(a,d,l,i,h,o,p,n),r[h+1]=r[h]=p)}}}s[i+1]=s[i]=r}for(;h<e.width;h+=2)u(h);E(s,e,i)}(t,function(t,e,n){var i=t[0],a=t[1],r=Math.round(i[0]),o=Math.max(Math.floor(i[1],0),0);Math.min(Math.ceil(a[0],e),e-1);return{x:r,y:o,xMax:e,yMax:Math.min(Math.ceil(a[1],n),n-1),width:e,height:n}}(l,p,f),g,function(t,e){j.field=e,S(t,e,g)})})},A=function(){j.field&&j.field.release(),R&&cancelAnimationFrame(R)},j={params:t,start:W,stop:A,update:function(e,n,i,a,r){delete t.data,t.data=e,r&&W(n,i,a,r)},shift:function(e,n){var i=t.canvas,a=i.width,r=i.height,o=i.getContext("2d");if(a>e&&r>n){var s=function(t,e){return Math.max(0,Math.min(t,e))},h=o.getImageData(s(a,-e),s(r,-n),s(a,a-e),s(r,r-n));o.clearRect(0,0,a,r),o.putImageData(h,s(a,e),s(r,n));for(var u=0,c=F.length;u<c;u++)F[u].x+=e,F[u].y+=n}},createField:E,interpolatePoint:w};return j};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/FRAME_RATE)},window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});var n=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},i=t.Map,a=t.layer.Image,r=t.source.ImageCanvas,o=t.proj;return function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};n(this,t),this.$options=i,this.$canvas=null,this.$data=e,this._timer=null,this.layer_=null}return t.prototype.getData=function(){return this.$data},t.prototype.setData=function(t){if(!this.$Map)return this;if(this.$data=t,!this.$Windy&&this.$canvas)this.render(this.$canvas),this.$Map.renderSync();else{var e=this.getExtent();this.$Windy.update(this.getData(),e[0],e[1],e[2],e[3])}return this},t.prototype.render=function(t){var n=this;if(!this.getData())return this;if(t&&!this.$Windy)this._timer&&window.clearTimeout(this._timer),this._timer=window.setTimeout(function(){n.$Windy=new e({canvas:t,projection:n.$options.hasOwnProperty("projection")?n.$options.projection:"EPSG:3857",data:n.getData()});var i=n.getExtent();n.$Windy.start(i[0],i[1],i[2],i[3]),n.onEvents()},0);else if(t&&this.$Windy){var i=this.getExtent();this.$Windy.start(i[0],i[1],i[2],i[3])}return this},t.prototype.getCanvasLayer=function(){if(!this.$canvas&&!this.layer_){var t=this.getMapExtent();this.layer_=new a({layerName:this.$options.layerName,minResolution:this.$options.minResolution,maxResolution:this.$options.maxResolution,zIndex:this.$options.zIndex,extent:t,source:new r({canvasFunction:this.canvasFunction.bind(this),projection:this.$options.hasOwnProperty("projection")?this.$options.projection:"EPSG:3857",ratio:this.$options.hasOwnProperty("ratio")?this.$options.ratio:1.5})}),this.$Map.addLayer(this.layer_),this.$Map.un("precompose",this.reRender,this),this.$Map.on("precompose",this.reRender,this)}},t.prototype.reRender=function(){if(this.layer_){var t=this.getMapExtent();this.layer_.setExtent(t)}},t.prototype.canvasFunction=function(t,e,n,i,a){var r,o,s;return this.$canvas||(this.$canvas=(r=i[0],o=i[1],(s=document.createElement("canvas")).width=r,s.height=o,s)),this.render(this.$canvas),this.$canvas},t.prototype.getExtent=function(){var t=this.$Map.getSize(),e=this.$Map.getView().calculateExtent(t),n=this.$options.hasOwnProperty("projection")?this.$options.projection:"EPSG:3857",i=o.transformExtent(e,n,"EPSG:4326");return[[[0,0],[t[0],t[1]]],t[0],t[1],[[i[0],i[1]],[i[2],i[3]]]]},t.prototype.getMapExtent=function(){var t=this.$Map.getSize();return this.$Map.getView().calculateExtent(t)},t.prototype.appendTo=function(t){if(!(t&&t instanceof i))throw new Error("not map object");this.$Map=t,this.getCanvasLayer()},t.prototype.clearWind=function(){this.$Map&&(this._timer&&window.clearTimeout(this._timer),this.$Windy&&this.$Windy.stop(),this.$Map.un("precompose",this.reRender,this),this.$Map.un("change:size",this.onChangeSize,this),this.$Map.removeLayer(this.layer_),delete this.$Map,delete this._timer,delete this.$Windy,delete this.layer_,delete this.$canvas)},t.prototype.onChangeSize=function(){if(this.$Windy){var t=this.getExtent();this.$Windy.start(t[0],t[1],t[2],t[3])}},t.prototype.onEvents=function(){var t=this.$Map;this.unEvents(),t.on("change:size",this.onChangeSize,this)},t.prototype.unEvents=function(){this.$Map.un("change:size",this.onChangeSize,this)},t}()});